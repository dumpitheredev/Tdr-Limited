{% extends 'components/generic_modal.html' %}

{% set modal_id = "addUserModal" %}
{% set modal_title = "Add New User" %}
{% set form_id = "addUserForm" %}
{% set submit_button_id = "createUserBtn" %}
{% set submit_button_text = "Create User" %}

{% block modal_content %}
<!-- First Name -->
<div class="mb-3">
    <label for="firstName" class="form-label fw-medium">First Name</label>
    <input type="text" 
           class="form-control" 
           id="firstName" 
           name="firstName"
           required
           style="border-radius: 8px; border-color: #E5E7EB;">
</div>

<!-- Last Name -->
<div class="mb-3">
    <label for="lastName" class="form-label fw-medium">Last Name</label>
    <input type="text" 
           class="form-control" 
           id="lastName" 
           name="lastName"
           required
           style="border-radius: 8px; border-color: #E5E7EB;">
</div>

<!-- Email Address -->
<div class="mb-3">
    <label for="email" class="form-label fw-medium">Email Address</label>
    <input type="email" 
           class="form-control" 
           id="email" 
           name="email"
           required
           style="border-radius: 8px; border-color: #E5E7EB;">
    <div class="invalid-feedback">
        Email addresses must match.
    </div>
</div>

<!-- Confirm Email Address -->
<div class="mb-3">
    <label for="confirmEmail" class="form-label fw-medium">Confirm Email Address</label>
    <input type="email" 
           class="form-control" 
           id="confirmEmail" 
           name="confirmEmail"
           required
           style="border-radius: 8px; border-color: #E5E7EB;">
    <div class="invalid-feedback">
        Email addresses must match.
    </div>
</div>

<!-- Role Selection -->
<div class="mb-3">
    <label for="userRole" class="form-label fw-medium">Select Role</label>
    <select class="form-select" 
            id="userRole" 
            name="userRole" 
            required
            style="border-radius: 8px; border-color: #E5E7EB;">
        <option value="" selected disabled>Choose a role</option>
        <option value="bh">Administrator</option>
        <option value="ak">Instructor</option>
        <option value="st">Student</option>
    </select>
</div>

<!-- Date of Birth -->
<div class="mb-3">
    <label for="dateOfBirth" class="form-label fw-medium">Date of Birth</label>
    <input type="date" 
           class="form-control" 
           id="dateOfBirth" 
           name="dateOfBirth"
           style="border-radius: 8px; border-color: #E5E7EB;">
</div>

<!-- Department - Visible only for Instructors -->
<div class="mb-3 instructor-field" style="display: none;">
    <label for="department" class="form-label fw-medium">Department</label>
    <input type="text" 
           class="form-control" 
           id="department" 
           name="department"
           placeholder="e.g., Computer Science, Mathematics"
           style="border-radius: 8px; border-color: #E5E7EB;">
</div>

<!-- Qualification - Visible only for Instructors -->
<div class="mb-3 instructor-field" style="display: none;">
    <label for="qualification" class="form-label fw-medium">Qualification</label>
    <input type="text" 
           class="form-control" 
           id="qualification" 
           name="qualification"
           placeholder="e.g., Ph.D., Masters"
           style="border-radius: 8px; border-color: #E5E7EB;">
</div>

<!-- Specialization - Visible only for Instructors -->
<div class="mb-3 instructor-field" style="display: none;">
    <label for="specialization" class="form-label fw-medium">Specialization</label>
    <input type="text" 
           class="form-control" 
           id="specialization" 
           name="specialization"
           placeholder="e.g., Machine Learning, Data Structures"
           style="border-radius: 8px; border-color: #E5E7EB;">
</div>

<!-- Company Selection - Visible only for Students -->
<div class="mb-3 student-field" style="display: none;">
    <label for="companyId" class="form-label fw-medium">Company</label>
    <select class="form-select" 
            id="companyId" 
            name="companyId"
            style="border-radius: 8px; border-color: #E5E7EB;">
        <option value="">No Company / Individual Student</option>
        <!-- Companies will be populated dynamically -->
    </select>
</div>

<!-- User ID -->
<div class="mb-4">
    <label for="userId" class="form-label fw-medium">User ID</label>
    <input type="text" 
           class="form-control bg-light" 
           id="userId" 
           value="Auto-generated, please select role" 
           disabled
           style="border-radius: 8px; border-color: #E5E7EB;">
</div>

<!-- Access Level - Visible only for Administrators -->
<div class="mb-3 admin-field" style="display: none;">
    <label for="accessLevel" class="form-label fw-medium">Access Level</label>
    <select class="form-select" 
            id="accessLevel" 
            name="accessLevel"
            style="border-radius: 8px; border-color: #E5E7EB;">
        <option value="">No Access Level Specified</option>
        <option value="full">Full Access</option>
        <option value="limited">Limited Access</option>
    </select>
    <small class="form-text text-muted mt-2">
        <i class="bi bi-info-circle"></i> Limited access restricts the ability to create, update, or delete records. 
        Users with limited access can only view data.
    </small>
</div>
{% endblock %}

{% block modal_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const roleSelect = document.getElementById('userRole');
    const userIdField = document.getElementById('userId');
    const createButton = document.getElementById('createUserBtn');
    const studentFields = document.querySelectorAll('.student-field');
    const instructorFields = document.querySelectorAll('.instructor-field');
    const adminFields = document.querySelectorAll('.admin-field');
    const companySelect = document.getElementById('companyId');

    // Function to generate random numbers (2 digits)
    function generateRandomNumbers() {
        return Math.floor(Math.random() * 90 + 10).toString(); // generates 10-99
    }

    // Function to generate random letters (2 letters)
    function generateRandomLetters() {
        const letters = 'abcdefghijklmnopqrstuvwxyz';
        return Array(2).fill(null)
            .map(() => letters.charAt(Math.floor(Math.random() * letters.length)))
            .join('');
    }

    // Function to generate user ID
    function generateUserId(prefix) {
        const numbers = generateRandomNumbers(); // 2 numbers (10-99)
        const letters = generateRandomLetters(); // 2 random letters
        return `${prefix}${numbers}${letters}`; // e.g., bh72zf
    }

    // Function to load companies
    function loadCompanies() {
        fetch('/api/companies')
            .then(response => response.json())
            .then(companies => {
                // Clear existing options except the first one
                companySelect.innerHTML = '<option value="">No Company / Individual Student</option>';
                
                // Add company options
                companies.forEach(company => {
                    const option = document.createElement('option');
                    option.value = company.company_id;
                    option.textContent = company.name;
                    companySelect.appendChild(option);
                });
            })
            .catch(error => {
                console.error('Error loading companies:', error);
            });
    }

    // Load companies when the page loads
    loadCompanies();

    // Listen for role selection change
    roleSelect.addEventListener('change', function() {
        if (this.value) {
            const newUserId = generateUserId(this.value);
            userIdField.value = newUserId;
            
            // Show/hide role-specific fields
            if (this.value === 'st') {
                // Show student fields, hide instructor and admin fields
                studentFields.forEach(field => field.style.display = 'block');
                instructorFields.forEach(field => field.style.display = 'none');
                adminFields.forEach(field => field.style.display = 'none');
            } else if (this.value === 'ak') {
                // Show instructor fields, hide student and admin fields
                instructorFields.forEach(field => field.style.display = 'block');
                studentFields.forEach(field => field.style.display = 'none');
                adminFields.forEach(field => field.style.display = 'none');
            } else if (this.value === 'bh') {
                // Show admin fields, hide student and instructor fields
                adminFields.forEach(field => field.style.display = 'block');
                studentFields.forEach(field => field.style.display = 'none');
                instructorFields.forEach(field => field.style.display = 'none');
            } else {
                // Hide all role-specific fields
                studentFields.forEach(field => field.style.display = 'none');
                instructorFields.forEach(field => field.style.display = 'none');
                adminFields.forEach(field => field.style.display = 'none');
            }
        } else {
            userIdField.value = 'Auto-generated';
            // Hide all role-specific fields
            studentFields.forEach(field => field.style.display = 'none');
            instructorFields.forEach(field => field.style.display = 'none');
            adminFields.forEach(field => field.style.display = 'none');
        }
    });

    // Form submission handler
    const form = document.getElementById('addUserForm');
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Email validation
        const email = document.getElementById('email').value.trim();
        const confirmEmail = document.getElementById('confirmEmail').value.trim();
        
        if (email !== confirmEmail) {
            // Use toast notification instead of browser alert
            if (typeof showToast === 'function') {
                showToast('Error', 'Email addresses do not match!', 'error');
            } else {
                console.error('Email validation failed: Email addresses do not match');
            }
            
            // Highlight the mismatched fields
            document.getElementById('email').classList.add('is-invalid');
            document.getElementById('confirmEmail').classList.add('is-invalid');
            
            // Re-enable form submission
            createButton.disabled = false;
            return;
        }
        
        // Clear any previous validation errors if emails match
        document.getElementById('email').classList.remove('is-invalid');
        document.getElementById('confirmEmail').classList.remove('is-invalid');

        // Disable button to indicate processing
        createButton.disabled = true;
        createButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Creating...';

        // Prepare data for API
        const formData = {
            firstName: document.getElementById('firstName').value.trim(),
            lastName: document.getElementById('lastName').value.trim(),
            email: email,
            userId: userIdField.value,
            userRole: roleSelect.value
        };
        
        // Add optional fields if they have values
        const dateOfBirth = document.getElementById('dateOfBirth').value;
        if (dateOfBirth) {
            formData.dateOfBirth = dateOfBirth;
        }
        
        // Add department for instructors
        if (roleSelect.value === 'ak') {
            const department = document.getElementById('department').value.trim();
            if (department) {
                formData.department = department;
            }
            
            const qualification = document.getElementById('qualification').value.trim();
            if (qualification) {
                formData.qualification = qualification;
            }
            
            const specialization = document.getElementById('specialization').value.trim();
            if (specialization) {
                formData.specialization = specialization;
            }
        }
        
        // Add access level for administrators
        if (roleSelect.value === 'bh') {
            const accessLevel = document.getElementById('accessLevel').value;
            if (accessLevel) {
                formData.accessLevel = accessLevel;
            }
        }
        
        // Add company for students
        if (roleSelect.value === 'st') {
            const companyId = document.getElementById('companyId').value;
            if (companyId) {
                formData.companyId = companyId;
            }
        }
        
        // Send data to API
        fetch('/api/users', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(formData)
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(data => {
                    throw new Error(data.error || 'Failed to create user');
                });
            }
            return response.json();
        })
        .then(data => {
            console.log('User created successfully:', data);
            
            // Show success message
            if (typeof showToast === 'function') {
                showToast('Success', data.message || 'User created successfully', 'success');
            }
            
            // Reset the form
            form.reset();
            
            // Hide the modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('addUserModal'));
            if (modal) {
                modal.hide();
            }
            
            // Reload the page to show the new user in the list
            // Only do this if we're on a user management page
            if (window.location.pathname.includes('user-management') || 
                window.location.pathname.includes('student-management') || 
                window.location.pathname.includes('instructor-management')) {
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            }
        })
        .catch(error => {
            console.error('Error creating user:', error);
            
            // Show error message
            if (typeof showToast === 'function') {
                showToast('Error', error.message || 'Failed to create user', 'error');
            }
        })
        .finally(() => {
            // Re-enable button
            createButton.disabled = false;
            createButton.innerHTML = 'Create User';
        });
    });
});
</script>
{% endblock %} 