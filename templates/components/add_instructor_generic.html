{% extends 'components/generic_modal.html' %}

{% set modal_id = "addInstructorModal" %}
{% set modal_title = "Add New Instructor" %}
{% set form_id = "addInstructorForm" %}
{% set submit_button_id = "createInstructorBtn" %}
{% set submit_button_text = "Create Instructor" %}

{% block modal_content %}
<!-- First Name -->
<div class="mb-3">
    <label for="firstName" class="form-label fw-medium">First Name</label>
    <input type="text" 
           class="form-control" 
           id="firstName" 
           name="firstName"
           required
           style="border-radius: 8px; border-color: #E5E7EB;">
</div>

<!-- Last Name -->
<div class="mb-3">
    <label for="lastName" class="form-label fw-medium">Last Name</label>
    <input type="text" 
           class="form-control" 
           id="lastName" 
           name="lastName"
           required
           style="border-radius: 8px; border-color: #E5E7EB;">
</div>

<!-- Email Address -->
<div class="mb-3">
    <label for="email" class="form-label fw-medium">Email Address</label>
    <input type="email" 
           class="form-control" 
           id="email" 
           name="email"
           required
           style="border-radius: 8px; border-color: #E5E7EB;">
    <div class="invalid-feedback">
        Email addresses must match.
    </div>
</div>

<!-- Confirm Email Address -->
<div class="mb-3">
    <label for="confirmEmail" class="form-label fw-medium">Confirm Email Address</label>
    <input type="email" 
           class="form-control" 
           id="confirmEmail" 
           name="confirmEmail"
           required
           style="border-radius: 8px; border-color: #E5E7EB;">
    <div class="invalid-feedback">
        Email addresses must match.
    </div>
</div>

<!-- Hidden Role Field -->
<input type="hidden" id="userRole" name="userRole" value="ak">

<!-- Date of Birth -->
<div class="mb-3">
    <label for="dateOfBirth" class="form-label fw-medium">Date of Birth</label>
    <input type="date" 
           class="form-control" 
           id="dateOfBirth" 
           name="dateOfBirth"
           style="border-radius: 8px; border-color: #E5E7EB;">
</div>

<!-- Department -->
<div class="mb-3">
    <label for="department" class="form-label fw-medium">Department</label>
    <input type="text" 
           class="form-control" 
           id="department" 
           name="department"
           placeholder="e.g., Computer Science, Mathematics"
           style="border-radius: 8px; border-color: #E5E7EB;">
</div>

<!-- Qualification -->
<div class="mb-3">
    <label for="qualification" class="form-label fw-medium">Qualification</label>
    <input type="text" 
           class="form-control" 
           id="qualification" 
           name="qualification"
           placeholder="e.g., Ph.D., Masters"
           style="border-radius: 8px; border-color: #E5E7EB;">
</div>

<!-- Specialization -->
<div class="mb-3">
    <label for="specialization" class="form-label fw-medium">Specialization</label>
    <input type="text" 
           class="form-control" 
           id="specialization" 
           name="specialization"
           placeholder="e.g., Machine Learning, Data Structures"
           style="border-radius: 8px; border-color: #E5E7EB;">
</div>

<!-- Instructor ID -->
<div class="mb-4">
    <label for="userId" class="form-label fw-medium">Instructor ID</label>
    <input type="text" 
           class="form-control bg-light" 
           id="userId" 
           value="Auto-generated" 
           disabled
           style="border-radius: 8px; border-color: #E5E7EB;">
</div>
{% endblock %}

{% block modal_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const userIdField = document.getElementById('userId');
    const prefix = 'ak'; // Fixed prefix for instructors
    const createButton = document.getElementById('createInstructorBtn');

    // Function to generate random numbers (2 digits)
    function generateRandomNumbers() {
        return Math.floor(Math.random() * 90 + 10).toString(); // generates 10-99
    }

    // Function to generate random letters (2 letters)
    function generateRandomLetters() {
        const letters = 'abcdefghijklmnopqrstuvwxyz';
        return Array(2).fill(null)
            .map(() => letters.charAt(Math.floor(Math.random() * letters.length)))
            .join('');
    }

    // Function to generate instructor ID
    function generateInstructorId() {
        const numbers = generateRandomNumbers(); // 2 numbers (10-99)
        const letters = generateRandomLetters(); // 2 random letters
        return `${prefix}${numbers}${letters}`; // e.g., ak72zf
    }

    // Generate ID when modal opens
    userIdField.value = generateInstructorId();

    // Form submission handler
    const form = document.getElementById('addInstructorForm');
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Email validation
        const email = document.getElementById('email').value.trim();
        const confirmEmail = document.getElementById('confirmEmail').value.trim();
        
        if (email !== confirmEmail) {
            // Use toast notification instead of browser alert
            if (typeof showToast === 'function') {
                showToast('Error', 'Email addresses do not match!', 'error');
            } else {
                console.error('Email validation failed: Email addresses do not match');
            }
            
            // Highlight the mismatched fields
            document.getElementById('email').classList.add('is-invalid');
            document.getElementById('confirmEmail').classList.add('is-invalid');
            
            // Re-enable form submission
            createButton.disabled = false;
            return;
        }
        
        // Clear any previous validation errors if emails match
        document.getElementById('email').classList.remove('is-invalid');
        document.getElementById('confirmEmail').classList.remove('is-invalid');

        // Disable button to indicate processing
        createButton.disabled = true;
        createButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Creating...';

        // Prepare data for API
        const formData = {
            firstName: document.getElementById('firstName').value.trim(),
            lastName: document.getElementById('lastName').value.trim(),
            email: email,
            userId: userIdField.value,
            userRole: 'ak' // instructor role
        };
        
        // Add optional fields if they have values
        const dateOfBirth = document.getElementById('dateOfBirth').value;
        if (dateOfBirth) {
            formData.dateOfBirth = dateOfBirth;
        }
        
        // Add instructor-specific fields
        const department = document.getElementById('department').value.trim();
        if (department) {
            formData.department = department;
        }
        
        const qualification = document.getElementById('qualification').value.trim();
        if (qualification) {
            formData.qualification = qualification;
        }
        
        const specialization = document.getElementById('specialization').value.trim();
        if (specialization) {
            formData.specialization = specialization;
        }
        
        // Send data to API
        fetch('/api/users', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(formData)
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(data => {
                    throw new Error(data.error || 'Failed to create instructor');
                });
            }
            return response.json();
        })
        .then(data => {
            console.log('Instructor created successfully:', data);
            
            // Show success message
            if (typeof showToast === 'function') {
                showToast('Success', data.message || 'Instructor created successfully', 'success');
            }
            
            // Reset the form
            form.reset();
            
            // Hide the modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('addInstructorModal'));
            if (modal) {
                modal.hide();
            }
            
            // Reload the page to show the new instructor in the list
            if (window.location.pathname.includes('instructor-management') || 
                window.location.pathname.includes('user-management')) {
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            }
        })
        .catch(error => {
            console.error('Error creating instructor:', error);
            
            // Show error message
            if (typeof showToast === 'function') {
                showToast('Error', error.message || 'Failed to create instructor', 'error');
            }
        })
        .finally(() => {
            // Re-enable button
            createButton.disabled = false;
            createButton.innerHTML = 'Create Instructor';
        });
    });
});
</script>
{% endblock %} 