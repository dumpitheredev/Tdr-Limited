{% extends "base/layout.html" %}

{% block title %}Instructor Management{% endblock %}

{% block head %}
{{ super() }}
<!-- Add CSRF token for form submissions -->
<meta name="csrf-token" content="{{ csrf_token() }}">
{% endblock %}

{% block header_title %}Instructor Management{% endblock %}

{% block content %}

<!-- Stats Cards -->
<div class="row g-3 mb-4">
    <div class="col-12 col-sm-6 col-md-4">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body d-flex flex-column">
                <div class="d-flex align-items-start justify-content-between">
                    <div>
                        <h6 class="text-muted mb-2">Total Instructors</h6>
                        <h2 class="mb-0" data-count="total">0</h2>
                    </div>
                    <div class="p-2 bg-primary-subtle rounded">
                        <i class="bi bi-people" style="color: #191970;"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-12 col-sm-6 col-md-4">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body d-flex flex-column">
                <div class="d-flex align-items-start justify-content-between">
                    <div>
                        <h6 class="text-muted mb-2">Active Instructors</h6>
                        <h2 class="mb-0" data-count="active">0</h2>
                    </div>
                    <div class="p-2 bg-success-subtle rounded">
                        <i class="bi bi-person-check" style="color: #198754;"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-12 col-sm-6 col-md-4">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body d-flex flex-column">
                <div class="d-flex align-items-start justify-content-between">
                    <div>
                        <h6 class="text-muted mb-2">Inactive Instructors</h6>
                        <h2 class="mb-0" data-count="inactive">0</h2>
                    </div>
                    <div class="p-2 bg-danger-subtle rounded">
                        <i class="bi bi-person-x" style="color: #dc3545;"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Instructor Table and other content -->
    <div class="col-12">
        <!-- Controls Row -->
        <div class="d-flex align-items-center justify-content-between mb-4">
            <!-- Left side: Status Filter and Search -->
            <div class="d-flex gap-3 flex-grow-1">
                <select id="statusFilter" class="form-select" style="width: 150px;">
                    <option value="">Select Status</option>
                    <option value="Active" {% if status_filter=='Active' %}selected{% endif %}>Active</option>
                    <option value="Inactive" {% if status_filter=='Inactive' %}selected{% endif %}>Inactive</option>
                </select>


                <div class="position-relative flex-grow-1" style="max-width: 400px;">
                    <i class="bi bi-search position-absolute top-50 start-0 translate-middle-y ms-3 text-muted"></i>
                    <input type="text" id="searchInput" class="form-control ps-5"
                        placeholder="Filter by name or instructor id">
                </div>
            </div>

            <!-- Right side: Action Buttons -->
            <div class="d-flex gap-2">
                <a href="{{ url_for('admin.export_instructors_to_csv') }}?status={{ status_filter }}&search={{ search_term }}"
                    class="btn" id="exportCSV" style="background-color: #191970; color: white;">
                    <i class="bi bi-arrow-up-right me-2"></i>Export CSV
                </a>
                <button class="btn" data-bs-toggle="modal" data-bs-target="#addInstructorModal"
                    style="background-color: #191970; color: white;">
                    <i class="bi bi-plus-lg me-2"></i>Add New Instructor
                </button>
            </div>
        </div>

        <!-- Instructor Table -->
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                <h3 class="h5 mb-0" style="color: #191970;">
                    <i class="bi bi-person-video3"></i> Instructor Records
                </h3>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table id="instructorTable" class="table table-hover align-middle">
                        <thead class="table-light">
                            <tr>
                                <th scope="col">Name</th>
                                <th scope="col">Role</th>
                                <th scope="col">Status</th>
                                <th scope="col" class="text-end">Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Loading indicator -->
                            <tr id="loadingIndicator">
                                <td colspan="4" class="text-center py-4">
                                    <div class="d-flex justify-content-center align-items-center">
                                        <div class="spinner-border text-primary me-2" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                        <span>Loading instructors...</span>
                                    </div>
                                </td>
                            </tr>
                            <!-- Table content will be dynamically loaded by JavaScript -->
                        </tbody>
                    </table>
                </div>

                <!-- Pagination Controls -->
                <div class="d-flex align-items-center gap-3 mt-3">
                    <div class="d-flex align-items-center gap-2">
                        <span class="text-body-secondary">Show rows per page:</span>
                        <select id="rowsPerPage" class="form-select form-select-sm" style="width: 80px;">
                            <option value="5" selected>5</option>
                            <option value="10">10</option>
                            <option value="25">25</option>
                            <option value="50">50</option>
                        </select>
                    </div>
                    <div class="ms-auto d-flex align-items-center gap-2">
                        <button id="prevPage" class="btn btn-sm btn-outline-secondary px-2" disabled>
                            <i class="bi bi-chevron-left"></i>
                        </button>
                        <span class="text-body-secondary" id="paginationInfo"
                            style="min-width: 100px; text-align: center;">
                            0 items
                        </span>
                        <button id="nextPage" class="btn btn-sm btn-outline-secondary px-2" disabled>
                            <i class="bi bi-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% include 'components/add_instructor_generic.html' %}
    {% include 'components/view_instructor_modal.html' %}
    {% include 'components/edit_instructor_modal.html' %}
    {% include 'components/toast_notification.html' %}

    <!-- Archive Confirmation Modal -->
    <div class="modal fade" id="confirmArchiveModal" tabindex="-1" aria-labelledby="confirmArchiveModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmArchiveModalLabel" style="color: #191970;">Confirm Archive</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="archiveInstructorId" value="">
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i>
                        <strong>Warning:</strong> This will archive the instructor record.
                    </div>
                    <p>Are you sure you want to archive this instructor? Archived instructors will be removed from the
                        main view.</p>
                    <p class="mb-0"><strong>Instructor: </strong><span id="archiveInstructorName">-</span></p>
                    <p class="mb-0"><strong>Instructor ID: </strong><span id="archiveInstructorIdDisplay">-</span></p>

                    <!-- Archive Reason Section -->
                    <div class="mt-3">
                        <label for="archiveReason" class="form-label fw-bold">Archive Reason:</label>
                        <select class="form-select" id="archiveReason" required>
                            <option value="" selected disabled>Select a reason...</option>
                            <option value="User no longer active">User no longer active</option>
                            <option value="Account suspended">Account suspended</option>
                            <option value="Course completed">Course completed</option>
                            <option value="Employment terminated">Employment terminated</option>
                            <option value="Duplicate account">Duplicate account</option>
                            <option value="At user's request">At user's request</option>
                            <option value="other">Other (specify)</option>
                        </select>
                        <div class="mt-2 d-none" id="customReasonContainer">
                            <input type="text" class="form-control" id="customReason" placeholder="Specify reason">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-danger" id="confirmArchiveBtn"
                            onclick="archiveInstructor()">Archive Instructor</button>
                    </div>
                </div>
            </div>
        </div>

        {% endblock %}

        {% block scripts %}
        <script>
            var currentPage = 1;
            var currentStatus = "";
            var currentPerPage = 5;
        </script>
        <script
            src="{{ url_for('static', filename='js/modals/instructor-modal.js') }}?v={{ now|default('') }}"></script>
        <script
            src="{{ url_for('static', filename='js/pages/instructor-management.js') }}?v={{ now|default('') }}"></script>
        {% endblock %}