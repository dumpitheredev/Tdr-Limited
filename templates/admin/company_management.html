{% extends "base/layout.html" %}
{% from 'components/table.html' import data_table %}
{% from 'components/view_student_modal.html' import view_student_modal %}

<!-- Import toast notification -->
{% include 'components/toast_notification.html' %}

{% block title %}Company Management{% endblock %}

{% block active_page %}company_management{% endblock %}

{% block header_title %}Company Management{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Info Cards Row -->
    <div class="row g-3 mb-4">
        <!-- Total Companies Card -->
        <div class="col-12 col-sm-6 col-lg-4">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <h6 class="card-subtitle text-muted mb-1">Total Companies</h6>
                            <h2 class="card-title mb-0 fw-bold total-companies">{{ total_companies }}</h2>
                        </div>
                        <div class="p-2 bg-primary bg-opacity-10 rounded">
                            <i class="bi bi-building-fill text-primary fs-4"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Active Companies Card -->
        <div class="col-12 col-sm-6 col-lg-4">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <h6 class="card-subtitle text-muted mb-1">Active Companies</h6>
                            <h2 class="card-title mb-0 fw-bold active-companies">{{ active_companies }}</h2>
                        </div>
                        <div class="p-2 bg-success bg-opacity-10 rounded">
                            <i class="bi bi-building-check text-success fs-4"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Inactive Companies Card -->
        <div class="col-12 col-sm-6 col-lg-4">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <h6 class="card-subtitle text-muted mb-1">Inactive Companies</h6>
                            <h2 class="card-title mb-0 fw-bold inactive-companies">{{ inactive_companies }}</h2>
                        </div>
                        <div class="p-2 bg-danger bg-opacity-10 rounded">
                            <i class="bi bi-building-dash text-danger fs-4"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Company Table and other content -->
        <div class="col-12">
            <!-- Controls Row -->
            <div class="d-flex align-items-center justify-content-between mb-4">
                <!-- Left side: Status Filter and Search -->
                <div class="d-flex gap-3 flex-grow-1">
                    <select id="statusFilter" class="form-select" style="width: 150px;">
                        <option value="">Select Status</option>
                        <option value="Active">Active</option>
                        <option value="Inactive">Inactive</option>
                    </select>

                    <div class="position-relative flex-grow-1" style="max-width: 400px;">
                        <i class="bi bi-search position-absolute top-50 start-0 translate-middle-y ms-3 text-muted"></i>
                        <input type="text" id="searchInput" class="form-control ps-5" placeholder="Filter by company name or id">
                    </div>
                </div>

                <!-- Right side: Action Buttons -->
                <div class="d-flex gap-2">
                    <button class="btn" 
                            id="exportCSV"
                            style="background-color: #191970; color: white;">
                        <i class="bi bi-arrow-up-right me-2"></i>Export CSV
                    </button>
                    <button class="btn" 
                            data-bs-toggle="modal" 
                            data-bs-target="#addCompanyModal"
                            style="background-color: #191970; color: white;">
                        <i class="bi bi-plus-lg me-2"></i>Add New Company
                    </button>
                </div>
            </div>

            <!-- Company Table -->
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                    <h3 class="h5 mb-0" style="color: #191970;">
                        <i class="bi bi-building-fill"></i>Company Records
                    </h3>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table id="companyTable" class="table table-hover align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>Contact Name</th>
                                    <th>Company Name</th>
                                    <th>Status</th>
                                    <th class="text-end">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Rows will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

                    <!-- Pagination Controls -->
                    <div class="d-flex align-items-center gap-3 mt-3">
                        <div class="d-flex align-items-center gap-2">
                            <span class="text-body-secondary">Show rows per page:</span>
                            <select id="rowsPerPage" class="form-select form-select-sm" style="width: 80px;">
                                <option value="5">5</option>
                                <option value="10" selected>10</option>
                                <option value="25">25</option>
                                <option value="50">50</option>
                            </select>
                        </div>
                        <div class="ms-auto d-flex align-items-center gap-2">
                            <button id="prevPage" 
                                    class="btn btn-sm btn-outline-secondary px-2" 
                                    disabled>
                                <i class="bi bi-chevron-left"></i>
                            </button>
                            <span class="text-body-secondary" id="paginationInfo" style="min-width: 100px; text-align: center;">
                                1-{{ companies|length }} of {{ companies|length }}
                            </span>
                            <button id="nextPage" 
                                    class="btn btn-sm btn-outline-secondary px-2"
                                    disabled>
                                <i class="bi bi-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% include 'components/add_company_modal.html' %}
{% include 'components/page_info_modal.html' %}

<!-- View Company Modal -->
<div class="modal fade" id="viewCompanyModal" tabindex="-1" aria-labelledby="viewCompanyModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="viewCompanyModalLabel">Company Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row g-3 mb-4">
                    <!-- Company Name -->
                    <div class="col-12">
                        <label class="form-label text-muted">Company Name</label>
                        <p id="viewCompanyName" class="fw-medium mb-0">-</p>
                    </div>

                    <!-- Company ID -->
                    <div class="col-md-6">
                        <label class="form-label text-muted">Company ID</label>
                        <p id="viewCompanyId" class="fw-medium mb-0">-</p>
                    </div>

                    <!-- Status -->
                    <div class="col-md-6">
                        <label class="form-label text-muted">Status</label>
                        <p class="mb-0">
                            <span id="viewCompanyStatus" class="badge">-</span>
                        </p>
                    </div>

                    <!-- Contact Person -->
                    <div class="col-12">
                        <label class="form-label text-muted">Contact Person</label>
                        <p id="viewCompanyContact" class="fw-medium mb-0">-</p>
                    </div>

                    <!-- Email -->
                    <div class="col-12">
                        <label class="form-label text-muted">Email</label>
                        <p id="viewCompanyEmail" class="fw-medium mb-0">-</p>
                    </div>
                </div>

                <!-- Students Table Section -->
                <div class="mt-4">
                    <div id="companyStudentsHeader"></div>
                    <h6 class="mb-3">Company Students</h6>
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr class="bg-light">
                                    <th>Name</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="companyStudentsTable">
                                <!-- Students will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Company Modal -->
<div class="modal fade" id="editCompanyModal" tabindex="-1" aria-labelledby="editCompanyModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editCompanyModalLabel">Edit Company</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="editCompanyForm">
                <div class="modal-body">
                    <div class="row g-3">
                        <!-- Company Name -->
                        <div class="col-12">
                            <label for="editCompanyName" class="form-label">Company Name</label>
                            <input type="text" class="form-control" id="editCompanyName" required>
                        </div>

                        <!-- Company ID -->
                        <div class="col-md-6">
                            <label for="editCompanyId" class="form-label">Company ID</label>
                            <input type="text" class="form-control" id="editCompanyId" readonly>
                        </div>

                        <!-- Status -->
                        <div class="col-md-6">
                            <label for="editCompanyStatus" class="form-label">Status</label>
                            <select class="form-select" id="editCompanyStatus" required>
                                <option value="Active">Active</option>
                                <option value="Inactive">Inactive</option>
                            </select>
                        </div>

                        <!-- Contact Person -->
                        <div class="col-12">
                            <label for="editCompanyContact" class="form-label">Contact Person</label>
                            <input type="text" class="form-control" id="editCompanyContact" required>
                        </div>

                        <!-- Email -->
                        <div class="col-12">
                            <label for="editCompanyEmail" class="form-label">Email</label>
                            <input type="email" class="form-control" id="editCompanyEmail" required>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary" style="background-color: #191970; border-color: #191970;">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

{{ view_student_modal() }}

{% endblock %}

{% block scripts %}
<script>
    var currentPage = 1;
    var currentStatus = "";
    var currentPerPage = 10;
    
    document.addEventListener('DOMContentLoaded', function() {
        // Basic filter functionality
        const searchInput = document.getElementById('searchInput');
        const statusFilter = document.getElementById('statusFilter');
        const exportBtn = document.getElementById('exportCSV');
        
        if (searchInput) {
            searchInput.addEventListener('input', filterCompanies);
        }
        
        if (statusFilter) {
            statusFilter.addEventListener('change', filterCompanies);
        }
        
        if (exportBtn) {
            exportBtn.addEventListener('click', function() {
                alert('Export functionality will be implemented in future updates');
            });
        }
        
        // Basic form handling
        const addCompanyForm = document.getElementById('addCompanyForm');
        if (addCompanyForm) {
            addCompanyForm.addEventListener('submit', function(e) {
                e.preventDefault();
                alert('Company creation will be implemented in future updates');
                const modal = bootstrap.Modal.getInstance(document.getElementById('addCompanyModal'));
                modal.hide();
            });
        }
    });
    
    function filterCompanies() {
        // Basic client-side filtering
        const searchValue = document.getElementById('searchInput').value.toLowerCase();
        const statusValue = document.getElementById('statusFilter').value;
        
        const rows = document.querySelectorAll('#companyTable tbody tr');
        let visibleCount = 0;
        
        rows.forEach(row => {
            const companyName = row.querySelector('td:first-child .fw-medium').textContent.toLowerCase();
            const contactName = row.querySelector('td:nth-child(2) div:first-child').textContent.toLowerCase();
            const status = row.querySelector('td:nth-child(3) .badge').textContent;
            
            const matchesSearch = searchValue === '' || 
                                  companyName.includes(searchValue) || 
                                  contactName.includes(searchValue);
                                  
            const matchesStatus = statusValue === '' || status === statusValue;
            
            if (matchesSearch && matchesStatus) {
                row.style.display = '';
                visibleCount++;
            } else {
                row.style.display = 'none';
            }
        });
        
        // Update pagination info
        document.getElementById('paginationInfo').textContent = visibleCount > 0 ? 
            `1-${visibleCount} of ${visibleCount}` : '0-0 of 0';
    }
    
    function handleCompanyAction(action, id) {
        alert(`${action} action for company ${id} will be implemented in future updates`);
    }
</script>
{% endblock %} 